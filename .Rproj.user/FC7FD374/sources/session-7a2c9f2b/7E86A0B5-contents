install.packages("tidytuesdayR")
install.packages("remotes")
remotes::install_github("thebioengineer/tidytuesdayR")
library(tidytuesdayR)
library(tidyverse)

emperors <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-08-13/emperors.csv")

# question of interest
# intended audience
# decribe and link to where the original data come from
# include a link to a data dictionary for the data

# must include some minimal form of data wrangling with you using at least five functions
# include at least three plots with at least three different geom_* functions
# Plots should have titles, subtitles, captions and proper axis labels
# At least one plot using a type of faceting
# must include one image or table
# must include at least two different callout blocks
# must include a .bib file, which you use to reference at least three unique citations
# must include the use of at least 1 margin content
# must summarize your analysis and/or results with a paragraph(4-6 sentences)
# At the end of the data analysis, list out each of the functions you used from each of the packages

## plot 1-a: how did roman emperors died? facet by era
emperors %>% 
  group_by(era) %>%
  count(cause,sort=TRUE) %>%
  mutate(era = factor(era,levels=c('Principate','Dominate'))) %>%
  ggplot(aes(x=tidytext::reorder_within(cause, n, within = era),n,fill=cause)) +
  geom_col() +
  tidytext::scale_x_reordered()+
  scale_fill_manual(values = c('Assassination'="#ED665D",
                               'Natural Causes'="#67BF5C",
                               'Execution'="#FF9E4A",
                               'Suicide'="#729ECE",
                               'Died in Battle'="#AD8BC9",
                               'Unknown'="#A2A2A2",
                               'Captivity'="#A8786E"))+
  coord_flip() +
  facet_grid(era~.,scales = "free_y")+
  theme(legend.position = "none")

# ## plot 1-b: death cause by percent in each dynasty
# emperors %>% 
#   group_by(dynasty) %>%
#   count(cause,sort=TRUE) %>%
#   mutate(cause = fct_reorder(cause,n))%>%
#   ggplot(aes(fill=dynasty, y=n, x=cause)) + 
#   geom_bar(position="stack", stat="identity")+
#   coord_flip()

## plot 1-b: who killed them?
emperors %>%
  filter(cause=='Assassination') %>%
  group_by(era) %>%
  count(killer,sort=TRUE) %>%
  # mutate(killer = tidytext::reorder_within(killer, n, within = era, sep = " ("))%>%
  # mutate(killer = fct_reorder(paste0(killer,")"),n))%>%
  mutate(era = factor(era,levels=c('Principate','Dominate'))) %>%
  ggplot(aes(tidytext::reorder_within(killer, n, within = era),n)) +
  geom_col()+
  tidytext:::scale_x_reordered()+
  coord_flip()+
  facet_grid(era~.,scales = "free_y")

## plot 2: reign length across time
# deal with BC time
y = as.numeric(as.Date("1970-01-01") - as.Date("0000-01-01"))
vertical_lines <- data.frame(xintercept = c(as.numeric(ymd('0235-03-18')), as.numeric(ymd('0284-11-20'))), color = c("blue", "red"))

#
emperors %>% 
  mutate(reign_start = case_when(
    name == "Augustus" ~ as.Date(-(as.numeric(as.Date("0026-01-16"))+y), "0000-01-01"),  # New value for Augustus
    TRUE ~ reign_start  # Keep the original value for other cases
  ))%>%
  mutate(name = fct_reorder(name,reign_start))%>%
  ggplot(aes(y=name))+
  geom_point(aes(x=reign_start),color='#F89217')+
  geom_point(aes(x=reign_end),color='#4F7CBA')+
  geom_segment(aes(x = reign_start, xend = reign_end, y = name, yend = name), color = "black", size = 1)+
  geom_vline(xintercept = as.numeric(ymd('0235-03-18'))) +
  geom_vline(xintercept = as.numeric(ymd('0284-11-20'))) 

  # geom_rect(aes(xmin = lag(xintercept), xmax = xintercept, ymin = -Inf, ymax = Inf, fill = color), alpha = 0.2) +
  # geom_smooth(aes(x = reign_start, y = name), method = "lm", se = FALSE, color = "green")  # Add spline line

# average reign time before crisis vs during vs after crisis
emperors.crisis <- emperors %>% 
  mutate(reign_start = case_when(
    name == "Augustus" ~ as.Date(-(as.numeric(as.Date("0026-01-16"))+y), "0000-01-01"),  # Adjust reign start date
    TRUE ~ reign_start  # Keep the original value for other cases
  )) %>%
  mutate(birth = case_when(
    name == "Augustus" ~ as.Date(-(as.numeric(as.Date("0062-09-23"))+y), "0000-01-01"),  # Adjust birth dates
    name == "Tiberius" ~ as.Date(-(as.numeric(as.Date("0041-11-16"))+y), "0000-01-01"),
    name == "Claudius" ~ as.Date(-(as.numeric(as.Date("0009-08-01"))+y), "0000-01-01"),
    name == "Galba"    ~ as.Date(-(as.numeric(as.Date("0002-12-24"))+y), "0000-01-01"),
    TRUE ~ birth  # Keep the original value for other cases
  )) %>%
  mutate(crisis = case_when(
    reign_start < ymd('0235-03-18') ~ 'Before',
    reign_start > ymd('0284-11-19') ~ 'After',
    TRUE ~ 'During'
    )) %>% 
  mutate(reign_length = reign_end - reign_start) %>%
  mutate(reign_age = reign_start - birth) %>%
  mutate(retire_age = reign_end - birth) %>%
  mutate(life_length = death - birth) %>%
  mutate(crisis = factor(crisis,levels=c('Before','During','After')))

## summarize
emperors.crisis %>%
  group_by(crisis) %>%
  filter(!is.na(birth)) %>%
  summarize(avg_reign = mean(reign_length), std_reign = sd(reign_length),avg_life = mean(life_length),std_life = sd(life_length))

emperors.crisis %>%
  summarize(mean(reign_length)/365.25)

## plot life_length
emperors.crisis %>%
  filter(!is.na(birth)) %>%
  ggplot(color=crisis) +
    geom_point(aes(y=retire_age/365.25,x= reign_age/365.25),size=0.8) +
    geom_abline(slope=1, intercept=0)+
    geom_abline(slope=1, intercept=8.39, color = 'red')


# Plot 2-ab redo the previous by crisis periods
emperors.crisis %>% 
  group_by(crisis) %>%
  count(cause,sort=TRUE) %>%
  # mutate(cause = tidytext::reorder_within(cause, n, within = crisis, sep = " ("))%>%
  # mutate(cause = fct_reorder(paste0(cause,")"),n))%>%
  ggplot(aes(x=tidytext::reorder_within(cause, n, within = crisis),y=n, fill=cause)) +
  geom_col() +
  tidytext::scale_x_reordered()+
  scale_fill_manual(values = c('Assassination'="#ED665D",
                               'Natural Causes'="#67BF5C",
                               'Execution'="#FF9E4A",
                               'Suicide'="#729ECE",
                               'Died in Battle'="#AD8BC9",
                               'Unknown'="#A2A2A2",
                               'Captivity'="#A8786E"))+
  coord_flip() +
  facet_grid(crisis~.,scales = "free_y")

emperors.crisis %>% 
  group_by(crisis) %>%
  count(cause,sort=TRUE) %>%
  mutate(cause = factor(cause,levels=c('Assassination','Natural Causes','Execution','Suicide','Died in Battle','Captivity','Unknown')))%>%
  ggplot(aes(fill=cause, y=n, x=crisis)) +
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = c('Assassination'="#ED665D",
                               'Natural Causes'="#67BF5C",
                               'Execution'="#FF9E4A",
                               'Suicide'="#729ECE",
                               'Died in Battle'="#AD8BC9",
                               'Unknown'="#A2A2A2",
                               'Captivity'="#A8786E"))

emperors.crisis %>% 
  group_by(crisis) %>%
  filter(cause == "Assassination") %>%
  count(killer,sort=TRUE) %>%
  mutate(killer = factor(killer))%>%
  ggplot(aes(fill=killer, y=n, x=crisis)) +
  geom_bar(position="stack", stat="identity")
  # scale_fill_manual(values = c('Assassination'="#ED665D",
  #                              'Natural Causes'="#67BF5C",
  #                              'Execution'="#FF9E4A",
  #                              'Suicide'="#729ECE",
  #                              'Died in Battle'="#AD8BC9",
  #                              'Unknown'="#A2A2A2",
  #                              'Captivity'="#A8786E"))

```{r fig.height=8,fig.width=10}
emperors.crisis %>% 
  group_by(crisis) %>%
  count(cause,sort=TRUE) %>%
  ggplot(aes(x=tidytext::reorder_within(cause, n, within = crisis),y=n, fill=cause)) +
  geom_col() +
  tidytext::scale_x_reordered()+
  scale_fill_manual(values = c('Assassination'="#ED665D",
                               'Natural Causes'="#67BF5C",
                               'Execution'="#FF9E4A",
                               'Suicide'="#729ECE",
                               'Died in Battle'="#AD8BC9",
                               'Unknown'="#A2A2A2",
                               'Captivity'="#A8786E"))+
  coord_flip() +
  facet_grid(crisis~.,scales = "free_y")+
  # Assign appropriate axis labels and titles  
  xlab('Death Causes')+
  ylab('Count') +
  labs(title = 'Reign length of each Roman emperors', 
       subtitle = 'Assassination was still a prominent cause of death before the crisis')+
  # Adjust text styles
  theme(axis.text = element_text(size = 14,face = 'bold'),
        axis.title = element_text(size = 16,face = 'bold'),
        plot.title = element_text(size = 20,face = 'bold',color = 'black'),
        legend.position = "none",
        plot.subtitle = element_text(size = 18),
        strip.text = element_text(size = 16))
```
